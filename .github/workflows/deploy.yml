name: Deploy to reg.ru w/ Tests Gate
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # ‚úÖ –ö–æ–¥ —Å–∞–π—Ç–∞
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'  # ‚úÖ –¢–≤–æ–π Node
      
      - name: Install deps
        run: npm ci  # ‚úÖ –ë—ã—Å—Ç—Ä–æ
      
      - name: Build PROD  # ‚úÖ –¢–≤–æ—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        run: |
            npx gulp clean:docs
            npx gulp html:docs  
            npx gulp sass:docs
            npx gulp images:docs
            npx gulp fonts:docs
            npx gulp files:docs
            npx gulp js:docs
      
      - name: List docs  # ‚úÖ Debug
        run: ls -la ./docs/
      
      # üöÄ –ù–û–í–û–ï: –¢–†–ò–ì–ì–ï–† + –ñ–î–ï–ú –¢–ï–°–¢–´ (5 –º–∏–Ω –º–∞–∫—Å)
      - name: üîß Trigger & Wait Tests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TESTS_PAT }}
          script: |
            console.log("üöÄ Trigger tests...");
            const trigger = await github.rest.actions.createWorkflowDispatch({
              owner: "Gvelet",
              repo: "QASpace-AQA-tests",
              workflow_id: "playwright.yml",
              ref: "main"
            });
            console.log("‚úÖ Tests triggered! Waiting...");
            
            // Poll –ø–æ—Å–ª–µ–¥–Ω–∏–µ runs workflow'–∞
            const timeout = Date.now() + 5*60*1000; // 5 –º–∏–Ω
            const pollInterval = 30000; // 30 —Å–µ–∫
            
            while (Date.now() < timeout) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: "Gvelet",
                repo: "QASpace-AQA-tests",
                workflow_id: "playwright.yml",
                per_page: 1
              });
              
              if (runs.total_count === 0) {
                console.log("‚è≥ No runs yet...");
              } else {
                const latest = runs.workflow_runs[0];
                console.log(`üìä Run ${latest.id}: ${latest.status} | ${latest.conclusion}`);
                
                if (latest.conclusion === "success") {
                  console.log("üéâ TESTS PASSED! ‚úÖ Proceed to deploy");
                  return;
                }
                if (latest.conclusion === "failure") {
                  console.log("üí• TESTS FAILED! ‚ùå Abort deploy");
                  process.exit(1);
                }
                if (latest.status === "completed") {
                  console.log("‚ùì Unknown conclusion:", latest.conclusion);
                }
              }
              await new Promise(r => setTimeout(r, pollInterval));
            }
            console.log("‚è∞ Timeout - assume failed");
            process.exit(1);


      # ‚úÖ FTP –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã green
      - name: Deploy FTP reg.ru  # ‚úÖ –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: './docs/'
          server-dir: '/www/qaspace.ru/'
          exclude: |
            **/.htaccess
            **/sitemap.xml
            **/robots.txt
            **/.gitkeep
          dangerous-clean-slate: false
          log-level: verbose
