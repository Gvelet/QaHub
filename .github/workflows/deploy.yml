name: Deploy to reg.ru and e2e
on:
  push:
    branches: [ main ]

jobs:
  deploy: # –î–µ–ø–ª–æ–π + —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–¥–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4' 
          cache: 'npm'

      - name: Install deps
        run: npm ci 
      
      - name: Build PROD 
        run: |
            npx gulp clean:docs
            npx gulp html:docs  
            npx gulp sass:docs
            npx gulp images:docs
            npx gulp fonts:docs
            npx gulp files:docs
            npx gulp js:docs
      
      - name: List docs 
        run: ls -la ./docs/
      
      - name: üîß Trigger & Wait Tests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TESTS_PAT }}
          script: |
            console.log("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤...");
            const trigger = await github.rest.actions.createWorkflowDispatch({
              owner: "Gvelet", repo: "QASpace-AQA-tests", 
              workflow_id: "playwright.yml", ref: "main" 
            });
            
            const timeout = Date.now() + 5*60*1000;  // 5 –º–∏–Ω
            const pollInterval = 60000;  // ‚Üë 60 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 30
            
            let pollCount = 0;
            while (Date.now() < timeout) {
              pollCount++;
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: "Gvelet", repo: "QASpace-AQA-tests",
                workflow_id: "playwright.yml", per_page: 1
              });
              
              if (runs.total_count === 0) {
                console.log(`‚è≥ ${pollCount}. No runs yet...`);
              } else {
                const latest = runs.workflow_runs[0];
                
                if (latest.status === 'queued') {
                  console.log(`üìä ${pollCount}. Run ${latest.id}: queued`);
                } else if (latest.status === 'in_progress' && latest.conclusion === null) {
                  if (pollCount % 3 === 0) {  // –ö–∞–∂–¥—ã–µ 3 –º–∏–Ω
                    console.log(`‚è≥ ${pollCount}. Tests running... (${Math.round((Date.now() - trigger.created_at) / 60000)} min)`);
                  }
                  continue;
                } else if (latest.conclusion === "success") {
                  console.log(`üéâ ${pollCount}. –¢–ï–°–¢–´ –ü–†–û–®–õ–ò! ‚úÖ –ü—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ deploy`);
                  return;
                } else if (latest.conclusion === "failure") {
                  console.log(`üí• ${pollCount}. –¢–ï–°–¢–´ –ù–ï –ü–†–û–®–õ–ò! ‚ùå –û–¢–ú–ï–ù–ê`);
                  process.exit(1);
                } else if (latest.status === "completed") {
                  console.log(`‚ùì ${pollCount}. –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º: ${latest.conclusion}`);
                  process.exit(1);
                }
              }
              await new Promise(r => setTimeout(r, pollInterval));
            }
            console.log("‚è∞ Timeout - assume failed");
            process.exit(1);



      # FTP –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã green
      - name: Deploy FTP reg.ru 
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: './docs/'
          server-dir: '/www/qaspace.ru/'
          exclude: |
            **/.htaccess
            **/sitemap.xml
            **/robots.txt
            **/.gitkeep
          dangerous-clean-slate: false
          log-level: verbose
