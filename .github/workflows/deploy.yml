name: Deploy to reg.ru w/ Tests Gate
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # ‚úÖ –ö–æ–¥ —Å–∞–π—Ç–∞
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.4'  # ‚úÖ –¢–≤–æ–π Node
      
      - name: Install deps
        run: npm ci  # ‚úÖ –ë—ã—Å—Ç—Ä–æ
      
      - name: Build PROD  # ‚úÖ –¢–≤–æ—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        run: npx gulp docs:build-only
      
      - name: List docs  # ‚úÖ Debug
        run: ls -la ./docs/
      
      # üöÄ –ù–û–í–û–ï: –¢–†–ò–ì–ì–ï–† + –ñ–î–ï–ú –¢–ï–°–¢–´ (5 –º–∏–Ω –º–∞–∫—Å)
      - name: üîß Trigger & Wait Tests  # ‚úÖ –ë–õ–û–ö –µ—Å–ª–∏ fail
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TESTS_PAT }}  # ‚úÖ –¢–≤–æ–π PAT
          script: |
            // 1. –¢–†–ò–ì–ì–ï–† —Ç–µ—Å—Ç–æ–≤
            console.log('üöÄ Trigger tests...');
            const trigger = await github.rest.actions.createWorkflowDispatch({
              owner: 'Gvelet',
              repo: 'QASpace-AQA-tests',
              workflow_id: 'playwright.yml',  # ‚úÖ –¢–æ—á–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
              ref: 'main'
            });
            const runId = trigger.data.id;
            console.log(`‚úÖ Triggered run ID: ${runId}`);

            // 2. POLL —Å—Ç–∞—Ç—É—Å (–ø–æ workflow_id + —Å–≤–µ–∂–∏–µ)
            console.log('‚è≥ Polling tests (5min max)...');
            const timeout = Date.now() + 5*60*1000;  # ‚úÖ 5 –º–∏–Ω
            const pollInterval = 30000;  # ‚úÖ 30 —Å–µ–∫

            while (Date.now() < timeout) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: 'Gvelet',
                repo: 'QASpace-AQA-tests',
                workflow_id: 'playwright.yml',  # ‚úÖ –§–∏–ª—å—Ç—Ä –ø–æ ID workflow!
                per_page: 1  # ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π
              });
              
              if (runs.total_count === 0) {
                console.log('‚è≥ No runs yet...');
              } else {
                const latest = runs.workflow_runs[0];
                console.log(`üìä Run ${latest.id}: ${latest.status} | ${latest.conclusion}`);
                
                if (latest.conclusion === 'success') {
                  console.log('üéâ TESTS PASSED! ‚úÖ Proceed to deploy');
                  return;  # ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º FTP
                }
                if (latest.conclusion === 'failure') {
                  console.log('üí• TESTS FAILED! ‚ùå Abort deploy');
                  process.exit(1);  # ‚úÖ –ö–†–ê–°–ù–´–ô JOB!
                }
              }
              await new Promise(r => setTimeout(r, pollInterval));
            }
            console.log('‚è∞ Timeout - assume failed');
            process.exit(1);  # ‚úÖ –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è

      # ‚úÖ FTP –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã green
      - name: Deploy FTP reg.ru  # ‚úÖ –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: './docs/'
          server-dir: '/www/qaspace.ru/'
          exclude: |
            **/.htaccess
            **/sitemap.xml
            **/robots.txt
            **/.gitkeep
          dangerous-clean-slate: false
          log-level: verbose
